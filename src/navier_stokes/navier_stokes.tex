%%%%%%%%%%%%%%%%%%%%%definitions%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{../../doc/related_pages/header.tex}
\input{../../doc/related_pages/newcommands.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%DOCUMENT%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{The heat diffusion project}
\author{ M.~Wiesenberger and M.~Held}
\maketitle

\begin{abstract}
    Test parallel advection and diffusion schemes on the 1d Navier-Stokes equations
    along a parallel magnetic field.
\end{abstract}
\tableofcontents

\section{Parallel advection schemes}
In this section we want to focus on the discretization of the Navier-Stokes equation
along a magnetic field-line:
\begin{align}
    \frac{\partial}{\partial t} n &= - \nc\left( nu\bhat\right) \\
    \frac{\partial}{\partial t} u &= - \npar\left(\frac{u^2}{2}\right) - \frac{\tau}{\mu} \frac{\npar n}{n} + \nu_u \frac{\Delta_\parallel u}{n}
\end{align}
with
\begin{align}
\Delta_\parallel u &= \nabla\cdot ( \bhat\bhat\cdot\nabla u)
\end{align}
$\bhat = \bhat(\vec x)$ is the prescribed magnetic field unit vector,
and $\nu_u$ is the viscosity coefficient parallel to this field.

The first equation is a linear advection type equation while the second one includes
a quadratic non-linearity (the Burger term $u^2/2$) which tends to generate
shocks (at least in the dissipationless case). This is because crests of a wave
travel faster than the valley of waves.
The continuity equation can be written as
\begin{align}
    \frac{\partial}{\partial t} n = - \npar (nu) - nu \nc\bhat = -u\npar n - n \npar u - nu\nc \bhat
\end{align}
The first term on the right hand side is the advection term (of density with velocity u). The second term is the wave term, because together with $\npar n$ in the velocity
equation it couples the two equations to make waves. This can be seen by linearizing
the system around $n= 1 + \tilde n$, $u = \tilde u$
\begin{align}
    \frac{\partial^2}{\partial t^2} \tilde n = \frac{\tau}{\mu} \npar^2 \tilde n + \frac{\tau}{\mu} \npar \tilde n \nc\bhat
\end{align}
This equation describes sound waves with speed $\sqrt{\tau/\mu}$ and a
dispersive term.

The above equations have the following conservative formulation:
\begin{align}
    \frac{\partial}{\partial t} n  + \nc\left( nu \bhat\right) &= 0 \\
    \frac{\partial}{\partial t} (\mu nu)  + \nc\left(\mu nu^2 \bhat\right) &=
    -\tau \npar n + \mu \nu_u \Delta_\parallel u \\
    \frac{\partial}{\partial t} \left(\tau n \ln n + \frac{1}{2}\mu nu^2\right)
    + \nc\left( \left( \tau n ( 1 + \ln n)  +\mu \frac{1}{2} nu^2\right) u\bhat \right) &= \mu \nu_u u \Delta_\parallel u
\end{align}
A good scheme:
\begin{itemize}
    \item respects the above written conservation equations, in particular when
        integrated over a flux-aligned volume the flux terms must vanish
    \item works with the FCI discretization developed in previous sections
\end{itemize}
Note that the latter point excludes discontinuous Galerkin methods, which we have not
yet developed for the FCI discretization.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Staggered grids in 1d}
When $\bhat = \xhat$ the system reduces to the one-dimensional Navier-Stokes equations for which there is a large amount of literature on numerical schemes available
( see for example \cite{LeVeque} and references therein).
\begin{align}
    \
    \frac{\partial}{\partial t} n &= - \frac{\partial}{\partial x}\left( nu\right) \\
    \frac{\partial}{\partial t} u &= - \frac{\partial}{\partial x}\left(\frac{u^2}{2} - \frac{\tau}{\mu} \ln n\right) + \nu_u \frac{1}{n}\frac{\partial^2}{\partial x^2} u
\end{align}

We here choose a class of schemes known as staggered grids. The main is to discretize
the variables $n$ and $u$ on two grids that are adjoint to each other.
If $n$ is discretized on the cell-centers $x_k$ then $u$ is discretized on the cell
boundaries $x_{k+1/2}$. We will indicate this by writing $u^\dagger_k$ that is $u^\dagger_k = u_{k+1/2}$.
We base our discretization on the finite volume scheme presented by
\cite{Gunawan2015,Herbin2013}:
\begin{align}
    \frac{n_k^{n+1} - n_k^n}{\Delta t} = - \frac{1}{\Delta x}(\hat q^\dagger_k  - \hat q^\dagger_{k-1})
\end{align}
where
\begin{align}
    \hat q^\dagger_k := u^\dagger_k \begin{cases}
        n_k     + \frac{1}{2}\Lambda( n_{k+1}-n_k    , n_k - n_{k-1})&\text{ if } u^\dagger_k \geq 0 \\
        n_{k+1} - \frac{1}{2}\Lambda( n_{k+2}-n_{k+1}, n_{k+1} - n_k)&\text{ if } u^\dagger_k < 0
    \end{cases}
\end{align}
and
\begin{align}
    \frac{(n_k^\dagger u_k^\dagger)^{n+1}-(n_k^\dagger u_k^\dagger)^{n}}{\Delta
    t} = - \frac{1}{\Delta x} \left[ \hat f_{k+1} - \hat f_k -
    \frac{\tau}{\mu} \left(n_{k+1}^{n+1} - n_k^{n+1}\right)  \right]
\end{align}
where $n^\dagger_k = \left(n_{k+1}+n_k\right)/2$ and $u_k =
\left(u^\dagger_k + u^\dagger_{k-1}\right)/2$ (local shock speed in Burger's equation)
and analogous for $q_k$ and
\begin{align}
    \hat f_k := q_k \begin{cases}
        u^\dagger_{k-1} + \frac{1}{2}\Lambda( u^\dagger_{k}-u^\dagger_{k-1}, u^\dagger_{k-1} - u^\dagger_{k-2})&\text{ if } q_k \geq 0 \\
        u^\dagger_k     - \frac{1}{2}\Lambda( u^\dagger_{k+1}-u^\dagger_k    , u^\dagger_k - u^\dagger_{k-1})&\text{ if } q_k < 0
    \end{cases}
\end{align}
where we have the flux limiter
\begin{align}
\Lambda_{\text{minmod}}(x,y) &:=
    \begin{cases}
        \min(x,y) & \text{ if } x,y \geq 0 \\
        \max(x,y) & \text{ if } x,y \leq 0 \\
        0         & \text{ else }
    \end{cases}
    \\
\Lambda_{\text{vanLeer}}(x,y) &:=
    \begin{cases}
        0               & \text{ if } xy \leq 0 \\
        \frac{2xy}{x+y} & \text{ else }
    \end{cases}
\end{align}

We note that this is a semi-implicit scheme (the pressure term in the momentum equation is implicit). The implicit equation can however be solved trivially because
the density equation decouples and is completely explicit.

We implement this scheme and investigate several variations in this notebook
\url{https://mwiesenberger.github.io/advection/OneDimensional.html}.

The authors of the scheme claim that if the pressure term is treated explicitly the
scheme loses its shock conserving properties. We cannot reproduce this behaviour
in our experiments. Furthermore, we were looking into discretizing the
velocity equation over the momentum formulation because the Feltor equations
prefer that formulation. In this formulation the equations are not shock-capturing
but are very close to the original scheme once viscosity is added to the system.

The best scheme that we found in this formulation is
\begin{align}
    \frac{n_k^{n+1} - n_k^n}{\Delta t} = &- \frac{1}{\Delta x}(q^\dagger_k  - q^\dagger_{k-1}) \\
    \frac{(u_k^\dagger)^{n+1}-(u_k^\dagger)^{n}}{\Delta t} = &- \frac{1}{\Delta
    x} \left[ \hat f_{k+1} -\hat f_k -
        \frac{\tau}{\mu} \left(n_{k+1} - n_k\right) \frac{1}{2}\left(\frac{1}{n_{k+1}}
    +\frac{1}{n_k}\right)\right]
    \nonumber\\
    &+ \frac{\nu_u}{n^\dagger_k (\Delta x)^2}
    \left(u^\dagger_{k+1} - 2 u^\dagger_k + u^\dagger_{k-1}\right)
\end{align}
with
\begin{align}
    \hat q^\dagger_k &:= u^\dagger_k \begin{cases}
        n_k     + \frac{1}{2}\Lambda( n_{k+1}-n_k    , n_k - n_{k-1})&\text{ if } u^\dagger_k \geq 0 \\
        n_{k+1} - \frac{1}{2}\Lambda( n_{k+2}-n_{k+1}, n_{k+1} - n_k)&\text{ if } u^\dagger_k < 0
    \end{cases}
    \\
    \hat f_k &:= \frac{1}{2}u_k \begin{cases}
        u^\dagger_{k-1} + \frac{1}{2}\Lambda( u^\dagger_{k}-u^\dagger_{k-1}, u^\dagger_{k-1} - u^\dagger_{k-2})&\text{ if } u_k \geq 0 \\
        u^\dagger_k     - \frac{1}{2}\Lambda( u^\dagger_{k+1}-u^\dagger_k    , u^\dagger_k - u^\dagger_{k-1})&\text{ if } u_k < 0
    \end{cases}
\end{align}
The discretization of the continuity equation remains unchanged from the original formulation.
\begin{tcolorbox}[title=Note]
    We divide by the harmonic mean in the pressure gradient term, which from empirical tests
    yields better convergence than other types like the arithmetic
    or geometric mean
\end{tcolorbox}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Elevating the scheme to three-dimensions}
Generalizing the scheme to the FCI formulation is somewhat straightforward
but care must taken since the grid is not equidistant.
Furthermore, we need to integrate the fieldlines twice, once to the next plane
and once to the adjoint plane between the original planes.
We denote the interpolation between the original planes with $I^+$ and $I^-$ and
the interpolation between the half planes with $P$ and $Q$. Similarly
we denote with $h^\pm$ the distances between the original planes and the distances
to the staggered grid with $h_s^\pm$.
Then we obtain
\begin{align}
n_k^\dagger &= \frac{1}{h_s^+ + h_s^-}\left( h_s^+ Qn_k + h_s^- Pn_{k+1}\right) \\
u_k &= \frac{1}{h_s^+ + h_s^-}\left( h_s^+ Qu^\dagger_{k-1} + h_s^- Pu_{k}^\dagger\right) \\
\left(\frac{1}{n}\right)_k^\text{harmonic} &= \frac{1}{h_s^+ + h_s^-}\left( \frac{h_s^+}{Qn_k} + \frac{h_s^-}{Pn_{k+1}}\right)
\end{align}
Such that in total we have
\begin{align}
    \frac{n_k^{n+1} - n_k^n}{\Delta t} = &-\frac{1}{h_s^+ + h_s^-}\left( P\hat
q_k^\dagger - Q\hat q_{k-1}^\dagger  + (h_s^- P q_k^\dagger + h_s^+Q
q_{k-1}^\dagger)\nc \bhat_k \right)
     \\
    \frac{(u_k^\dagger)^{n+1}-(u_k^\dagger)^{n}}{\Delta t} = &-
 \frac{1}{h_s^+ + h_s^-}\left( P\hat f_{k+1} - Q\hat f_k\right)
 -\frac{\tau}{\mu} \frac{[\npar n]^\dagger_k}{(h_s^+ + h_s^-)}\left( \frac{h_s^-}{Pn_{k+1}} + \frac{h_s^+}{Qn_k} \right)
    \nonumber\\
    &+ \frac{\nu_u}{n^\dagger_k }
    \left(\npar^2 u^\dagger + \npar u^\dagger \nc \bhat\right)_k
\end{align}
The fluxes are discretized according to
\begin{align}
    \hat q^\dagger_k &:= u^\dagger_k \begin{cases}
        Qn_k     + h_s^-\Lambda\left( (\npar n)^\dagger_k, I^- (\npar n)^\dagger_{k-1}\right)&\text{ if } u^\dagger_k \geq 0 \\
        Pn_{k+1} - h_s^+\Lambda\left( I^+(\npar n)^\dagger_{k+1}, (\npar n)^\dagger_k\right) &\text{ if } u^\dagger_k < 0
    \end{cases}
    \\
    \hat f_k &:= \frac{1}{2}u_k\begin{cases}
        Qu^\dagger_{k-1} + h_s^-\Lambda\left( (\npar u^\dagger )_k, I^- (\npar u^\dagger)_{k-1}\right)&\text{ if } u_k \geq 0 \\
        Pu^\dagger_{k}   - h_s^+\Lambda\left( I^+(\npar u^\dagger)_{k+1}, (\npar u^\dagger)_k\right) &\text{ if } u_k < 0 \\
    \end{cases}
\end{align}
with
\begin{align}
\left[\npar u^\dagger \right]_k =& \frac{1}{h_s^+ + h_s^-}\left( P
u^\dagger_{k} - Q u^\dagger_{k-1}\right) \\
\left[\npar n\right]^\dagger_k =& \frac{1}{h_s^+ + h_s^-}\left( Pn_{k+1} -
Q n_k\right)
\end{align}
\begin{tcolorbox}[title=Note]
    The term in front of $\nc\bhat$ in the first line of the continuity equation
    is chosen as the mean flux since empirically
    this leads to better mass conservation.
\end{tcolorbox}
\begin{tcolorbox}[title=Note]
    The diffusive terms are discretized in a centered discretization.
\end{tcolorbox}

To ensure that the discretization of the fluxes indeed provides 2nd order
when the slope limiter is used we compare orders or a Taylor expansion.
We compute
 (assuming $u_k^\dagger \geq 0$)
\begin{align*}
    P\hat n_k^\dagger - Q \hat n_{k-1}^\dagger =
    P(  Q n_k + h_s^- ( P n_{k+1} - Q n_k) / (h_s^+ + h_s^-) )
    \\
    - Q ( Q n_{k-1} + h_s^- (P n_k -Q n_{k-1})/(h_s^+ + h_s^-))
    \\
    =
    P((  h_s^+Q n_k + h_s^-  P n_{k+1}) / (h_s^+ + h_s^-))
   \\
    - Q (( h_s^+ Q n_{k-1} + h_s^- P n_k )/(h_s^+ + h_s^-))
    \\
    \approx \left( Ph_s^+ n_k + Ph_s^- I^+ n_{k+1}\right)/(Ph_s^+ + Ph_s^-) - \left(Qh_s^+ I^- n_{k-1} - Q h_s^- n_k\right)/(Qh_s^+ + Qh_s^-)
\end{align*}
Inserting the Taylor expansion
\begin{align}
I^+n_{k+1} = n_0 + n' h^+ + \frac{1}{2} n'' (h^+)^2 \\
I^-n_{k-1} = n_0 - n' h^- + \frac{1}{2} n'' (h^-)^2
\end{align}
with $h^+ = Ph_s^+ + P h_s^-$ and $h^- = Q_s^+ + Qh_s^-$ and $Qh_s^+ = h_s^-$ and $Ph_s^- = h_s^+$
we see that the zeroth order vanishes and the first order yields $n'(h_s^+ + h_s^-)$, which
is necessary for consistency. Gathering second order terms we get
$n'' (h_s^+ h^+ - h_s^- h^-)$, which yields $0$ to lowest order in $\Delta\varphi$
where $2h_s^+ = 2h_s^- = h^- = h^+ =  b_\varphi \Delta \varphi $.
The discretization is therefore 2nd order in $\Delta\varphi$.

\end{document}
